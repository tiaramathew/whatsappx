generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model WebhookEvent {
  id           Int      @id @default(autoincrement())
  instanceName String   @map("instance_name")
  eventType    String   @map("event_type")
  payload      Json
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([instanceName])
  @@index([eventType])
  @@index([createdAt])
  @@map("webhook_events")
}

model MessageStat {
  id           Int      @id @default(autoincrement())
  instanceName String   @map("instance_name")
  remoteJid    String   @map("remote_jid")
  direction    String
  messageType  String   @map("message_type")
  status       String
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([instanceName])
  @@index([remoteJid])
  @@index([createdAt])
  @@map("message_stats")
}

model ContactCache {
  id             Int      @id @default(autoincrement())
  instanceName   String   @map("instance_name")
  remoteJid      String   @unique @map("remote_jid")
  pushName       String?  @map("push_name")
  profilePicture String?  @map("profile_picture")
  isGroup        Boolean  @default(false) @map("is_group")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([instanceName])
  @@map("contacts_cache")
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  username      String    @unique
  password      String
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  failedLogins  Int       @default(0) @map("failed_logins")
  lockedUntil   DateTime? @map("locked_until")
  evolutionApiUrl String? @map("evolution_api_url")
  evolutionApiKey String? @map("evolution_api_key")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  createdById   Int?      @map("created_by_id")
  createdBy     User?     @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers  User[]    @relation("UserCreatedBy")
  assignedRoles UserRole[] @relation("UserAssignedRole")
  userRoles     UserRole[]
  sessions      Session[]
  auditLogs     AuditLog[]
  subscription  Subscription?
  broadcasts    Broadcast[]
  aiAgents      AIAgent[]
  instanceConfigs InstanceConfig[]

  @@index([email])
  @@index([username])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  userRoles   UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  resource    String    // e.g., "instances", "messages", "contacts", "webhooks", "users"
  action      String    // e.g., "create", "read", "update", "delete", "manage"
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  rolePermissions RolePermission[]

  @@index([resource])
  @@index([action])
  @@map("permissions")
}

model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  roleId    Int      @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedById Int?   @map("assigned_by_id")
  assignedBy User?   @relation("UserAssignedRole", fields: [assignedById], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id          Int      @id @default(autoincrement())
  roleId      Int      @map("role_id")
  permissionId Int     @map("permission_id")
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission  Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String   // e.g., "login", "logout", "create_user", "update_settings"
  resource   String?  // e.g., "user", "instance", "webhook"
  resourceId String?  @map("resource_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

model RateLimitEntry {
  id         Int      @id @default(autoincrement())
  key        String   @unique // IP address or user ID
  count      Int      @default(1)
  windowStart DateTime @default(now()) @map("window_start")
  
  @@index([key])
  @@index([windowStart])
  @@map("rate_limit_entries")
}

model Subscription {
  id               Int       @id @default(autoincrement())
  userId           Int       @unique @map("user_id")
  stripeCustomerId String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String? @unique @map("stripe_subscription_id")
  stripePriceId    String?   @map("stripe_price_id")
  status           String    @default("inactive") // active, past_due, canceled, incomplete, incomplete_expired, trialing, unpaid, paused
  currentPeriodEnd DateTime? @map("current_period_end")
  planName         String?   @map("plan_name")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Broadcast {
  id           Int            @id @default(autoincrement())
  userId       Int            @map("user_id")
  instanceName String         @map("instance_name")
  name         String
  message      String         @db.Text
  mediaUrl     String?        @map("media_url")
  mediaType    String?        @map("media_type") // image, video, document, audio
  status       String         @default("draft") // draft, scheduled, processing, completed, failed
  scheduledAt  DateTime?      @map("scheduled_at")
  startedAt    DateTime?      @map("started_at")
  completedAt  DateTime?      @map("completed_at")
  totalRecipients Int         @default(0) @map("total_recipients")
  successCount Int            @default(0) @map("success_count")
  failedCount  Int            @default(0) @map("failed_count")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs         BroadcastLog[]

  @@index([userId])
  @@index([instanceName])
  @@index([status])
  @@map("broadcasts")
}

model BroadcastLog {
  id          Int       @id @default(autoincrement())
  broadcastId Int       @map("broadcast_id")
  recipient   String
  status      String    @default("pending") // pending, sent, failed
  error       String?
  sentAt      DateTime? @map("sent_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  broadcast   Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  @@index([broadcastId])
  @@index([recipient])
  @@index([status])
  @@map("broadcast_logs")
}

model AIAgent {
  id           Int      @id @default(autoincrement())
  name         String
  systemPrompt String   @map("system_prompt") @db.Text
  aiAgentId    Int?     @map("ai_agent_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiAgent      AIAgent? @relation(fields: [aiAgentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([instanceName])
  @@map("instance_configs")
}

model Contact {
  id            Int       @id @default(autoincrement())
  instanceName  String    @map("instance_name")
  remoteJid     String    @map("remote_jid")
  name          String?
  pushName      String?   @map("push_name")
  profilePicUrl String?   @map("profile_pic_url")
  email         String?
  phone         String?
  tags          String[]
  customFields  Json?     @map("custom_fields")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastSeenAt    DateTime? @map("last_seen_at")

  groups        ContactGroupMember[]
  conversations Conversation[]

  @@unique([instanceName, remoteJid])
  @@map("contacts")
}

model ContactGroup {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  instanceName String   @map("instance_name")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  members      ContactGroupMember[]

  @@map("contact_groups")
}

model ContactGroupMember {
  id        Int      @id @default(autoincrement())
  contactId Int      @map("contact_id")
  groupId   Int      @map("group_id")
  joinedAt  DateTime @default(now()) @map("joined_at")

  contact   Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  group     ContactGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([contactId, groupId])
  @@map("contact_group_members")
}

model Conversation {
  id             Int       @id @default(autoincrement())
  instanceName   String    @map("instance_name")
  remoteJid      String    @map("remote_jid")
  contactId      Int?      @map("contact_id")
  unreadCount    Int       @default(0) @map("unread_count")
  lastMessageAt  DateTime? @map("last_message_at")
  lastMessage    String?   @map("last_message")
  status         String    @default("open") // open, closed, archived
  
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  contact        Contact?  @relation(fields: [contactId], references: [id])
  messages       Message[]

  @@unique([instanceName, remoteJid])
  @@map("conversations")
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int          @map("conversation_id")
  keyId          String       @unique @map("key_id")
  fromMe         Boolean      @map("from_me")
  type           String       @default("text")
  content        String?      @db.Text
  mediaUrl       String?      @map("media_url")
  mediaType      String?      @map("media_type")
  status         String       @default("pending") // pending, sent, delivered, read, failed
  timestamp      DateTime     @default(now())
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}